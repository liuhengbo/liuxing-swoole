# IM 通信概念

## 回顾

webSocket测试:在线测试工具;js

## 即时通信和实时通信

本质: 都是信息交互

不同: 交互的事件关系,信息的要求

即时通信: 文字聊天,语音发送,文件传输,直播,音频视频播放,发短信等

实时通信: 群发,视频电话会议,打电话等

即时通信: 主要要求可靠,考核点在延迟(效率) -> TCP

实时通信: 延迟最低,可靠的问题 -> UDP

## 架构->演变

单体架构 -> 集群(完整项目部署到不同服务器)->分布式(项目多个模块部署在不同服务器)

分布式:
     
    //好处
    1. 单模块维护扩展性高
    2. 耦合低
    3. 增加灵活度,通过接口信息交互-远程调度
    4. 合理利用服务器资源
    // 缺点
    1. 系统之间交互通信
    2. 成本 -> 开发难度大
    3. 各个模块之间通用的业务逻辑无法共用
    
微服务:

实现分布式部署即是微服务 -> 项目模块分割到最小单位 -> 认为一个模块就是一个单独的项目

微服务不一定是分布式部署,分布式部署一定是微服务 (composer组件类似)

分布式指的是部署方式,微服务指的的架构的设计方式
    
    

## IM即时通信架构介绍

客户端 -> 路由层 -> IM服务 -> 注册/发现


流程:

    1. 客户端向Route发起登录
    2. 登录成功从redis当中选择可用的im-server返回给客户端,并保存登录,路由信息到redis
    3. 客户端像im-server发起长连接,成功后保持心跳
    4. 客户端下线时清除状态信息

> IM-Server服务端

1. 用于接收 Client 连接、消息推送等功能。支持集群部署。
2. 检测客户端存活状态，心跳时间为300秒/500秒，心跳过快耗电过多，心跳过慢有可能被电信运营（400ms）商切断连接
3. 设备/用户登录退出操作，更新Redis中的状态
4. 消息进行双向确认/重传/去重。发送消息后，客户端必须回复ACK确认包，才认为已成功。否则进行重传，客户端对服务器推送的消息进行去重，避免收到重复的消息

>  Route消息路由服务器

1. 检测IM-server的存活状态
2. 支持权限认证
3. 根据服务器的状态，按照一定的算法，计算出该客户端连接到哪台IM-server，返回给客户端，客户端再去连接到对应的服务端,保存客户端与IM-server的路由关系
4. 如果 IM-server宕机，会自动从Redis中当中剔除
5. IM-server上线后连接到Route，自动加 入Redis
6. 可以接受来自PHP代码、C++程序、Java程序的消息请求，转发给用户所在的IM-server
7. 缓存服务器地址，多次查询redis

> redis

1. 存储client的登入信息比如fd
2. 绑定用户信息

>  Client客户端

就是模拟websocket层

1. 消息通讯，及消息应答ack
2. 心跳保持及断开重连

> 启动流程

1. 启动route服务,启动redis
2. 启动IM-Server -> 自动向Route发送请求 -> 做一个登记记录在redis (Route会检测Im-Server的服务的状态,并及时清空不存活的服务器)
3. 客户端连接 -> 找到route服务器,route服务从redis获取服务器信息
4. route服务把Im-SErver返回给客户端
5. 客户端再与服务建立连接,服务器把用户连接信息记录在redis中
6. 客户端断开连接,服务器清空redis中信息


## RPC是什么

远程过程的调用（解决内部系统之间的调用）

> Rest和Rpc的区别

1. Rest API(一般是HTTP协议) 对外,RPC(可以TCP,可以WebSocket,udp,http)对内
2. RPC可以通过开通多端口进行实现
3. IPC　必须可靠
